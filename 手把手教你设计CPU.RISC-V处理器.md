#读书《手把手教你设计CPU.RISC-V处理器》，作者胡振波。

这两年国产化、信创呼声越来越高，尤其是关于核心芯片CPU国产化的卡脖子问题，越来越引起国家的重视，这本书从从业者角度讲清楚了CPU的分类，以及各自现状；如果我国要解决CPU卡脖子问题，应该从哪个方向进行突破。

### 一、CPU的分类

#### 1. X86

x86 是由 Intel 公司推出的一种复杂指令集（CISC）。x86 架构由 Intel 与 AMD 共同经过数代的发展，相继从最初的 16 位架构发展到如今的64 位架构。在 x86 架构刚诞生的时代，CISC 还是业界主流，因此，x86 架构是具有代表性的可变指令长度的 CISC 指令架构。虽然之后 RISC 已经取代 CISC 成为现代指令集架构的主流，但是，由于 Intel 公司的巨大成功以及为了维护软件的向后兼容性，x86 作为一种 CISC架构被一直保留下来。事实上，Intel 公司通过内部“微码化”的方法克服掉了 CISC 架构的部分缺点，加上 Intel 高超的 CPU 设计水平与工艺制造水平，使得 x86 处理器一直保持着旺盛的战斗力，不断刷新个人计算机处理器芯片性能的极限。

所谓“微码化”是指将复杂的CISC 指令先用硬件解码器翻译成对应的内部简单指令（微码）序列，然后送给处理器流水线执行的方法，使得 x86 的处理器核也变成了一种 RISC 的形式，从而能够借鉴 RISC 架构的优点。不过，额外的硬件解码器同样也会带来额外的复杂度与面积开销，这是 x86 架构作为一种 CISC 架构不得不付出的代价。

#### 2. SPARC

SPARC是Sun 公司与1985 年设计推出的指令集架构，全称为“可扩充处理器架构（Scalable Processor ARChitecture，SPARC）”，是一种非常有代表性的高性能 RISC 架构。由于 SPARC 架构是面向服务器领域而设计的，能够带来非常高的性能，但是这种架构由于功耗面积代价太大而并不适用于 PC与嵌入式领域处理器。

SPARC 架构应用的另外一个比较知名的领域是航天领域。美国的航天星载系统中普遍使用的 Power 架构，欧洲太空局为了独立发展自己的航天能力而选择了开发基于 SPARC 架构的 LEON 处理器，并对其进行了抗辐射加固设计，使之能够应用于航天环境中。但是从本质上来讲，航天领域处理器对于指令集架构本身并无特殊要求，其需求的主要特性是提供工艺上的加固单元和硬件系统的容错性处理（为了防止外太空强辐射造成电路失常）。因此，很多的航天处理器也采用了其他的处理器架构，譬如目前新开发的很多航天处理器也在使用新的 ARM 或者 RISC-V 架构。

#### 3. MIPS

MIPS（Microprocessor without Interlocked Piped Stages Architecture）亦为 Millions ofInstructions Per Second 的相关语，是一种简洁、优化的 RISC 架构。尽管MIPS 是最早的经典 RISC 架构，但是由于一些商业运作的原因，MIPS 被同属 RISC 阵营的 ARM 后来居上。2013 年 MIPS被英国公司 Imagination Technologies 收购，可惜的是，MIPS 被 Imagination 收购后，日渐衰落。

#### 4. Power

Power架构是IBM开发的一种RISC架构指令集。基于Power架构的IBM Power服务器系统在可靠性、可用性和可维护性等方面表现出色，使得IBM从芯片到系统所涉及的整机方案有着独有的优势。Power架构处理器在超算、银行金融、大型企业的高端服务器等多个方面应用十分成功。

#### 5. Alpha

Alpha 也称为 Alpha AXP，是一种 64 位的 RISC 指令集架构，由 DEC 公司设计开发，被用于 DEC 自己的工作站和服务器中。Alpha 是一款优秀的处理器，它不仅是最早跨过 GHz 的企业级处理器，而且还是最早计划采用双核，甚至是多核架构的处理器。然而，Alpha 芯片和采用此芯片的服务器并没有得到整个市场的认同，只有少数人选择了 Alpha 服务器。据称其价格高昂、安装复杂，部署实施远远超过一般企业 IT 管理人员所能承受的难度。2001 年，康柏收购 DEC 之后，逐步将其全部 64 位服务器系列产品转移到 Intel 的安腾处理器架构之上。

#### 6. ARM

ARM架构过于声名显赫。但是有必要先对 ARM 的授权模式进行介绍。简而言之，ARM公司的主要授权模式可以分为两种。

- 授权“ARM 处理器 IP”给其他的芯片生产商（合作伙伴），后者直接使用 ARM 处理器 IP 设计 SoC 芯片。
- 授权“ARM 架构”给其他的芯片生产商（合作伙伴），后者基于 ARM 架构自研其处理器核，然后使用自研处理器核设计 SoC 芯片。

需要注意的是：购买 ARM 的处理器 IP 进行 SoC 芯片开发的国内公司众多，但是由于其直接使用 ARM 公司的处理器 IP，并不属于真正的自主“处理器核”开发。

#### 7. ARC

ARC 架构处理器是 Synopsys 公司推出的 32 位 RISC 结构微处理器系列 IP。ARC 处理器的 IP 产品线覆盖了从低端到高端各个领域的嵌入式处理器，ARC 架构处理器以极高的能效比见长，出色的硬件微架构使得 ARC 处理器的各项指标均令人印象深刻。ARC 处理器 IP以追求功耗效率比（DMIPS/mW）和面积效率比（DMIPS/mm2）最优化为目标，以满足嵌入式市场对微处理器产品日益提高的效能要求。

ARC 是除了 ARM 之外的全球第二大嵌入式处理器 IP 供应商，全球已有超过 170 家客户使用 Synopsys ARC 处理器，这些客户每年总共产出高达 15 亿块基于 ARC 的芯片。

#### 8. Andes

Andes 架构处理器是中国台湾省的晶心（Andes）公司推出的一系列 32 位 RISC 架构处理器 IP。据 2016 年的统计数字，采用 Andes 指令集架构的系统芯片出货量超过 4.3 亿颗，总累计出货量超过 19 亿颗。2017 年，Andes 发布最新一代的 AndeStar™处理器架构，成为商用主流 CPU IP 公司中第一家纳入开放 RISC-V 指令集架构的公司。 

#### 9. C-Sky

C-SKY 架构处理器是由杭州中天微系统有限公司开发的一系列 32 位高性能低功耗嵌入式处理器 IP。杭州中天是国内 CPU IP 公司的翘楚，C-SKY 系列嵌入式 CPU 核，具有低功耗、高性能、高代码密度、易使用等特点。

### 二、国产CPU

#### 1. MIPS系：龙芯和君正

龙芯 CPU 由中国科学院计算技术所龙芯课题组研制，由中国科学院计算技术所授权的北京神州龙芯集成电路设计公司研发。

北京君正也属于 MIPS 阵营，与龙芯着力于桌面 PC 处理器不同，北京君正是国内较早专注于可穿戴、物联网领域的本土 IC设计公司之一，拥有十多年的芯片设计经验和技术积累，其最大的特点就是具有较高的性能功耗比。国内第一批上市的智能手表都采用了君正的方案。

#### 2. x86系：北大众志、兆芯和海光

北京北大众志微系统科技有限责任公司成立于 2002 年 11 月，是国家集成电路设计行业的重要骨干企业。2005 年，AMD 与中国政府达成了协议，科技部指定北大微电子中心接收AMD Geode-2 处理器的技术授权，AMD 的处理器无疑是 x86 架构，中国因此获得了 x86 技术。不过 Geode 处理器属于 AMD 嵌入式处理器，因此 AMD 授权给北大的 x86 技术属于嵌入式架构。

上海兆芯，也许被更多的人所熟知。众所周知，核心的 x86 架构是 Intel 和 AMD 公司的核心技术，美国政府也会严格控制其技术的授权。不过，除了 Intel 和AMD，另外一家中国台湾公司威盛（VIA）也曾经拥有 x86 架构授权。兆芯的x86授权来自于VIA。

天津海光。2016 年，AMD 宣布与中国天津海光投资公司达成了协议，将 x86 技术授权给海光公司，获得授权费，并且双方还会成立合资公司，授权其生产服务器处理器。

#### 3. Power系：中晟宏芯

BM 于 2013 年联合 NVIDIA 等公司成立 OpenPower 开放联盟，其他公司也可以获得 Power 架构授权。此后还推动成立了中国POWER 技术产业生态联盟，与多家中国公司签署了授权协议，中晟宏芯就是其中的一家。中晟宏芯成立于 2013 年。

#### 4. Alpha系：申威

在 2016年国际超算大会评比中，基于申威 26010 处理器的“神威太湖之光”超级计算机系统首次亮相并夺冠，其峰值性能达每秒 12.5×108亿次浮点运算，成为世界首台运行速度超 109 亿次的超级计算机。

#### 5. ARM系：飞腾、华为海思、展讯和华芯通

以上四家公司都是被授权“ARM 架构”进行处理器核的自研，属于自主研发一类。

飞腾公司是中国国防科技大学高性能处理器研究团队建立的企业，国防科大多年来在CPU 领域的耕耘积累了雄厚的技术实力。

华为海思目前是我国技术最强大的芯片开发商之一。华为的麒麟芯片在性能上与高通、三星这些领先的芯片企业处于一个水平。同时华为目前也是国内四大服务器提供商之一，华为、联想、浪潮等国产服务器企业占有中国服务器市场的份额已经超过 65%。华为在几年前便已经购买了 ARM 指令集架构授权，开始研发自有的处理器核，主攻服务器市场。

展讯是另一家国内手机芯片的翘楚。2016 年展讯的芯片出货达到 6.7 亿套，2017 年 6 月宣布成功研发其自主的 ARM 架构处理器，展讯宣称在 SC9850 4 核（Cortex-A7）芯片同样大的面积上实现了 6 核的设计，功耗和性能都可以按照自己的需求调配，标志着展讯成为了除苹果、三星两家智能手机厂商之外（三星和苹果的自主芯片主要都是自用），继高通之后，第二家拥有自主 ARM CPU 关键技术的手机芯片厂商。

2016 年，高通与中国贵州政府合资在华成立了一家芯片公司——华芯通半导体，旨在专门为中国市场设计与开发服务器专用芯片的公司。华芯通已获 ARM v8-A 架构授权，在市场上推出先进服务器芯片组技术，帮助中国企业在本土市场提供基于 ARM 的服务器技术，从而推动高效服务器解决方案的大规模部署。

### 三、自主研发的困境

对于一款CPU来说，硬件技术并不是最重要的，其指令集架构（ISA）才是关键。目前商业主流的指令集架构在不同的领域已经各自出现了明显的霸主格局，其中，x86 架构统治着桌面 PC 与服务器领域；ARM 架构统治着移动手持领域，同时对桌面 PC 和服务器领域全面进军，另外ARM 在嵌入式领域占据绝对优势。如果选择跟随x86和ARM有其局限性，表现在：

#### 1. x86架构

由于 Intel 与 AMD 本身是芯片公司而不是知识产权（IP）公司，因此 x86 架构是其生命线，假设其他得到授权的芯片公司使用 x86 架构生产的芯片对 Intel 和 AMD 造成了实质威胁时，Intel 与 AMD 完全可以拿起专利的大棒停止授权。另外x86 架构的授权费用极为高昂，远非普通公司或者组织能够染指。

#### 2. ARM架构

ARM 公司是 ARM生态的主导者和核心规则的制定者，通过基础架构授权、IP 核授权等方式获得经济收益。而生态系统中大量的上下游软硬件企业则遵循 ARM 统一制定的标准规范，对接众多客户需求而实现经济利益的获取。

国内基于 ARM 生态的 CPU 产业已有较好基础，华为海思、展讯、联芯和飞腾等众多企业均已累积多年的 ARM 芯片研发经验，在移动终端领域我国芯片设计技术已与国际主流水平同步。

但是ARM 架构毕竟属于 ARM 公司，一方面需要为 ARM 公司支付极其高昂的授权费（一次数千万美金），另一方面被软银收购后 ARM 现在属于一家日本公司。因此，从绝对的自主可控的角度来看，受制于人那是在所难免的。

### 四、RISC-V的登场

2016 年，RISC-V 这一全新ISA突然自带光环登场。它开源共享，不属于某一家商业公司私有，因此也就不会有受制于人与自主可控的隐忧，更加不需要向商业公司支付高昂的授权费。它以开放共赢为基本原则，有一个统一的非营利组织作为主导者和核心规则的制定者，任何公司和个人都可以永久免费地使用其架构。RISC-V 基金会负责维护标准的 RISC-V 架构文档和编译器等 CPU 所需的软件工具链，任何组织和个人可以随时在 RISC-V 基金会网站上免费下载（无须注册）

RISC-V（英文读作“risk-five”），是一种全新的指令集架构。“V”包含两层意思，一是这是 Berkeley 从 RISC I 开始设计的第五代指令集架构；二是它代表了变化（Variation）和向量（Vectors）。经过几年的开发，伯克利为 RISC-V 架构开发除了完整的软件工具链以及若干开源的处理器实例，得到越来越多的人的关注。

RISC-V 架构的设计哲学是什么呢？是“大道至简”，简单就是美，简单便意味着可靠。RISC-V 架构，则具备了后发优势。由于计算机体系结构经过多年的发展已经是一个比较成熟的技术，多年来在不断成熟的过程中暴露的问题都已经被研究透彻了，因此新的 RISC-V 架构能够加以规避，并且没有背负向后兼容的历史包袱，可以说是无病一身轻目前的“RISC-V 架构文档”分为“指令集文档”和“特权架构文档”。“指令集文档”的篇幅为 100 多页，而“特权架构文档”的篇幅也仅为 100 页左右。熟悉体系结构的工程师仅需一两天便可将其通读，虽然“RISC-V 的架构文档”还在不断地丰富，但是相比“x86的架构文档”与“ARM 的架构文档”，RISC-V 的篇幅可以说是极其短小精悍。

RISC-V 架构采用了x86和ARM架构不具备的模块化设计理念，能够使得用户灵活地选择不同的模块进行组合，以满足不同的应用场景，可以说是“老少咸宜”。基本的RISC-V 指令数目仅有 40 多条，加上其他的模块化扩展指令总共几十条指令

当然，一款指令集架构（ISA）最终能否取得成功，很大程度上取决于软件生态环境。x86 与 ARM 架构经过多年的经营，构建了城宽池阔的软件生态环境，可以说是兵精粮足，非常强大。因此，作者认为 RISC-V 架构在短时间内还无法对 x86 和ARM 架构形成撼动。但是随着越来越多的公司和项目开始采用 RISC-V 架构的处理器，相信 RISC-V 的软件生态也会逐步壮大起来。

### 五、如何设计RISC-V芯片

本书后续就是非常技术化的介绍了一款基于RISC-V架构的国内CPU设计实现蜂鸟E200，如果对深入此行业感兴趣的读者可以进行深入阅读。